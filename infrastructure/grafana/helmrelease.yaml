apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
  namespace: flux-system
spec:
  releaseName: grafana
  serviceAccountName: helm-controller
  targetNamespace: "${infranamespaceprefix}grafana"
  chart:
    spec:
      chart: grafana/grafana
      version: 6.48.0
      sourceRef:
        kind: HelmRepository
        name: pauwels-labs
        namespace: flux-system
  interval: 1m0s
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  values:
    image:
      repository: 274295908850.dkr.ecr.eu-west-1.amazonaws.com/i/grafana/grafana
      tag: 9.3.1
    service:
      port: 3000
      targetPort: 3000
    sidecar:
      image:
        repository: 274295908850.dkr.ecr.eu-west-1.amazonaws.com/i/kiwigrid/k8s-sidecar
        tag: 1.21.0
      alerts:
        enabled: true
        label: pauwelslabs.com/alerts
        labelValue: "true"
      dashboards:
        enabled: true
        label: pauwelslabs.com/dashboards
        labelValue: "true"
      datasources:
        enabled: true
        label: pauwelslabs.com/datasources
        labelValue: "true"
    # extraConfigmapMounts:
    # - name: dashboard-definitions
    #   mountPath: /grafana-dashboard-definitions/0
    #   configMap: grafana-dashboard-definitions
    #   readOnly: true
    # dashboardProviders:
    #   dashboardproviders.yaml:
    #     apiVersion: 1
    #     providers:
    #     - name: '0'
    #       orgId: 1
    #       folder: 'Default'
    #       type: file
    #       options:
    #         path: /grafana-dashboard-definitions/0
    # dashboards:
    #   "0":
    #     mimir-alertmanager-resources:
    #       file: mimir-alertmanager-resources.json
    #     mimir-alertmanager:
    #       file: mimir-alertmanager.json
    #     mimir-compactor-resources:
    #       file: mimir-compactor-resources.json
    #     mimir-compactor:
    #       file: mimir-compactor.json
    #     mimir-config:
    #       file: mimir-config.json
    #     mimir-object-store:
    #       file: mimir-object-store.json
    #     mimir-overrides:
    #       file: mimir-overrides.json
    #     mimir-overview-networking:
    #       file: mimir-overview-networking.json
    #     mimir-overview-resources:
    #       file: mimir-overview-resources.json
    #     mimir-overview:
    #       file: mimir-overview.json
    #     mimir-queries:
    #       file: mimir-queries.json
    #     mimir-reads-networking:
    #       file: mimir-reads-networking.json
    #     mimir-reads-resources:
    #       file: mimir-reads-resources.json
    #     mimir-reads:
    #       file: mimir-reads.json
    #     mimir-remote-ruler-reads-resources:
    #       file: mimir-remote-ruler-reads-resources.json
    #     mimir-remote-ruler-reads:
    #       file: mimir-remote-ruler-reads.json
    #     mimir-rollout-progress:
    #       file: mimir-rollout-progress.json
    #     mimir-ruler:
    #       file: mimir-ruler.json
    #     mimir-scaling:
    #       file: mimir-scaling.json
    #     mimir-slow-queries:
    #       file: mimir-slow-queries.json
    #     mimir-tenants:
    #       file: mimir-tenants.json
    #     mimir-top-tenants:
    #       file: mimir-top-tenants.json
    #     mimir-writes-networking:
    #       file: mimir-writes-networking.json
    #     mimir-writes-resources:
    #       file: mimir-writes-resources.json
    #     mimir-writes:
    #       file: mimir-writes.json
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
        - name: mimir
          orgId: 1
          editable: false
          type: prometheus
          url: http://grafana-mimir-query-frontend.${infranamespaceprefix}grafana-mimir.svc:9095
          access: proxy
          isDefault: true
          version: 1
    grafana.ini:
      auth.basic:
        enabled: false
      auth.jwt:
        allow_assign_grafana_admin: true
        auto_sign_up: true
        email_claim: email
        enabled: true
        expect_claims: "{\"iss\": \"https://identity.pauwelslabs.com/realms/pauwels-labs-main\"}"
        header_name: x-forwarded-access-token
        jwk_set_url: https://identity.pauwelslabs.com/realms/pauwels-labs-main/protocol/openid-connect/certs
        role_attribute_path: contains(roles[*], 'dashboards-admin') && 'GrafanaAdmin' || contains(roles[*], 'dashboards-editor') && 'Editor' || 'Viewer'
        username_claim: preferred_username
      auth.proxy:
        auto_sign_up: true
        enabled: false
        header_name: x-forwarded-preferred-username
        header_property: username
        headers: id:x-forwarded-user groups:x-forwarded-groups
        sync_ttl: 60
      date_formats:
        default_timezone: UTC
      server:
        root_url: https://dashboards.pauwelslabs.com
        domain: ""
