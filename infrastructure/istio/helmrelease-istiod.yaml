apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: istio-istiod
  namespace: flux-system
spec:
  releaseName: istio-istiod
  serviceAccountName: helm-controller
  targetNamespace: istio-system
  chart:
    spec:
      chart: istio/istiod
      version: 1.15.0
      sourceRef:
        kind: HelmRepository
        name: pauwels-labs
        namespace: flux-system
  interval: 1m
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  values:
    revision: "1-15-0"
    revisionTags: ["stable"]
    meshConfig:
      extensionProviders:
      - name: keycloak-broker
        envoyExtAuthzHttp:
          service: "https://identity.pauwelslabs.com/realms/pauwels-labs/broker/oidc/endpoint"
          port: 443
          includeRequestHeadersInCheck: ["authorization", "cookie"]
          headersToUpstreamOnAllow: ["authorization", "path", "x-auth-request-user", "x-auth-request-email", "x-auth-request-access-token"]
          headersToDownstreamOnDeny: ["content-type", "set-cookie"]
      defaultConfig:
        gatewayTopology:
          # The PROXY protocol is enabled on both the NLB and inside
          # Istio, allowing the NLB to transfer source IP exclusively
          # over L4 rather than L7. The Istio gateway then picks up
          # the source IP and places it accessible over L7 via the
          # X-Forwarded-For header. In this context, since the gateway
          # is the first proxy to set the X-Forwarded-For header, it
          # should be considered to have no proxies in front of it
          # (even though the NLB is there).
          numTrustedProxies: 0
    global:
      hub: 274295908850.dkr.ecr.eu-west-1.amazonaws.com/istio
      # proxy:
      #   logLevel: debug
