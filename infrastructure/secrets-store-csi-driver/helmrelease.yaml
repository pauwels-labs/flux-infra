apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: secrets-store-csi-driver
  namespace: flux-system
spec:
  releaseName: secrets-store-csi-driver
  serviceAccountName: helm-controller
  targetNamespace: secrets-store-csi-driver
  chart:
    spec:
      chart: kubernetes-sigs/secrets-store-csi-driver
      version: 1.2.4
      sourceRef:
        kind: HelmRepository
        name: pauwels-labs
        namespace: flux-system
  interval: 2m
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  postRenderers:
  - kustomize:
      patchesJson6902:
      - target:
          version: batch/v1
          kind: Job
          name: secrets-store-csi-driver-upgrade-crds
        patch:
        - op: remove
          path: /spec/template/spec/containers/0/args
        - op: add
          path: /spec/template/spec/containers/0/command
          value:
          - /bin/sh
          - -c
          - "until wget -qO- -o /dev/null \"http://localhost:15021/healthz/ready\"; do echo \"WAITING FOR SIDECAR\"; sleep 3; done; echo \"SIDECAR AVAILABLE\"; /kubectl apply -f crds/; command_return_code=$(echo $?); echo \"QUITTING SIDECAR\"; wget -qO- -o /dev/null --post-data \"\" http://localhost:15020/quitquitquit > /dev/null; echo \"SIDECAR SHUTDOWN COMMAND ISSUED\"; exit $command_return_code;"
      - target:
          version: batch/v1
          kind: Job
          name: secrets-store-csi-driver-keep-crds
        patch:
        - op: remove
          path: /spec/template/spec/containers/0/args
        - op: add
          path: /spec/template/spec/containers/0/command
          value:
          - /bin/sh
          - -c
          - "until wget -qO- -o /dev/null \"http://localhost:15021/healthz/ready\"; do echo \"WAITING FOR SIDECAR\"; sleep 3; done; echo \"SIDECAR AVAILABLE\"; /kubectl patch crd secretproviderclasses.secrets-store.csi.x-k8s.io secretproviderclasspodstatuses.secrets-store.csi.x-k8s.io -p '{\"metadata\":{\"annotations\": {\"helm.sh/resource-policy\": \"keep\"}}}'; command_return_code=$(echo $?); echo \"QUITTING SIDECAR\"; wget -qO- -o /dev/null --post-data \"\" http://localhost:15020/quitquitquit > /dev/null; echo \"SIDECAR SHUTDOWN COMMAND ISSUED\"; exit $command_return_code;"
  values:
    syncSecret:
      enabled: true
    enableSecretRotation: true
    linux:
      image:
        repository: 274295908850.dkr.ecr.eu-west-1.amazonaws.com/kubernetes-sigs/secrets-store-csi-driver
        tag: v1.2.4
      crds:
        annotations:
          proxy.istio.io/config: '{ "holdApplicationUntilProxyStarts": true }'
        image:
          repository: 274295908850.dkr.ecr.eu-west-1.amazonaws.com/kubernetes-sigs/secrets-store-csi-driver-crds
          tag: v1.2.4
      registrarImage:
        repository: 274295908850.dkr.ecr.eu-west-1.amazonaws.com/sig-storage/csi-node-driver-registrar
        tag: v2.5.1
      livenessProbeImage:
        repository: 274295908850.dkr.ecr.eu-west-1.amazonaws.com/sig-storage/livenessprobe
        tag: v2.7.0
