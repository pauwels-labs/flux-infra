kind: ConfigMap
metadata:
  name: grafana-agent-metrics
apiVersion: v1
data:
  agent.yaml: |
    server:
      log_level: debug
    metrics:
      wal_directory: /var/lib/agent/wal
      global:
        scrape_interval: 60s
        external_labels:
          cluster: ${clustername}
          region: ${clusterregion}
          az: ${az}
      configs:
      - name: integrations
        remote_write:
        - url: http://127.0.0.1:20202/push
        scrape_configs:
        - job_name: integrations/kubernetes/cadvisor
          bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          kubernetes_sd_configs:
          - role: node
          relabel_configs:
          - replacement: kubernetes.default.svc:443
            target_label: __address__
          - regex: (.+)
            replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
            source_labels:
            - __meta_kubernetes_node_name
            target_label: __metrics_path__
          - replacement: pauwels-labs-main
            target_label: tenant
          scheme: https
          tls_config:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            insecure_skip_verify: false
            server_name: kubernetes
        - job_name: integrations/kubernetes/kubelet
          bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          kubernetes_sd_configs:
          - role: node
          relabel_configs:
          - replacement: kubernetes.default.svc:443
            target_label: __address__
          - regex: (.+)
            replacement: /api/v1/nodes/$1/proxy/metrics
            source_labels:
            - __meta_kubernetes_node_name
            target_label: __metrics_path__
          - replacement: pauwels-labs-main
            target_label: tenant
          scheme: https
          tls_config:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            insecure_skip_verify: false
            server_name: kubernetes
        - job_name: integrations/kubernetes/kube-state-metrics/https-main
          bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          kubernetes_sd_configs:
          - role: service
          metric_relabel_configs:
          - action: drop
            regex: kube_endpoint_address_not_ready|kube_endpoint_address_available
            source_labels:
            - __name__
          relabel_configs:
          - action: labeldrop
            regex: (pod|service|endpoint|namespace)
          - replacement: pauwels-labs-main
            target_label: tenant
          - source_labels:
            - __meta_kubernetes_service_label_app.kubernetes.io/component
            - __meta_kubernetes_service_label_app.kubernetes.io/name
            - __meta_kubernetes_service_label_app.kubernetes.io/part-of
            action: keep
            regex: (exporter;kube-state-metrics;kube-prometheus)
          - source_labels:
            - __meta_kubernetes_service_port_name
            action: keep
            regex: https-main
          - source_labels:
            - __meta_kubernetes_service_label_app.kubernetes.io/name
            target_label: job
            replacement: ${1}
          scheme: https
          tls_config:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            insecure_skip_verify: false
            server_name: kubernetes
